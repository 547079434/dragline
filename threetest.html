<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8>
    <title>My first three.js app</title>
    <script type="text/javascript" src="js/jquery-3.2.0.min.js"></script>
    <script type="text/javascript" src="js/threejs/three.min.js"></script>
    <script type="text/javascript" src="js/threejs/jspack/Detector.js"></script>
    <script type="text/javascript" src="js/threejs/jspack/loaders/OBJLoader.js"></script>
    <script type="text/javascript" src="js/threejs/jspack/loaders/MTLLoader.js"></script>
    <script type="text/javascript" src="js/threejs/jspack/libs/stats.min.js"></script>
    <script type="text/javascript" src="js/threejs/jspack/controls/TrackballControls.js"></script>
    <style>
        html,body{margin: 0;width: 100%;height: 100%;overflow: hidden;}
    </style>
</head>
<body>

</body>
<script>
    var scene,camera,renderer,controls,mesh,model;
    var light,pointlight;
    
    function init(){
        scene = new THREE.Scene();                  // 场景
        camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);                                  // 相机
        camera.position.x = 0;
        camera.position.y = 100;
        camera.position.z = 500;
        //设置相机的上为z轴方向
        // camera.up.x = 0;
        // camera.up.y = 1;
        // camera.up.z = 0;
        //设置视野的中心坐标
        // camera.lookAt({
        //     x : 0,
        //     y : 0,
        //     z : 0
        // });
        renderer = new THREE.WebGLRenderer({antialias:true});       // 渲染器(属性：抗锯齿)
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        // renderer.setClearColor(0xFFFFFF, 1.0);
        controls = new THREE.TrackballControls(camera);           // 漫游器

        // 地板
        var gt = new THREE.TextureLoader().load( "images/grasslight-big.jpg" );
        var gg = new THREE.PlaneBufferGeometry( 2000, 2000 );
        var gm = new THREE.MeshPhongMaterial( { color: 0xffffff, map: gt } );
        var ground = new THREE.Mesh( gg, gm );
        ground.rotation.x = - Math.PI / 2;
        ground.material.map.repeat.set( 8, 8 );
        ground.material.map.wrapS = ground.material.map.wrapT = THREE.RepeatWrapping;
        ground.receiveShadow = true;
        scene.add( ground );

        document.body.appendChild(renderer.domElement);
    }
    
    // 光
    function initLight(){
        // 环境光
        // var ambientLight = new THREE.AmbientLight(0xffffff);  
        // scene.add(ambientLight);  
        // 平行光
        // light = new THREE.DirectionalLight('#fff',1);
        // light.position.set(0,1,1);
        // scene.add(light);
        // 聚光灯
        var spotlight = new THREE.SpotLight( 0xffffff, 2, 1000 );
        spotlight.position.set( -100, 350, 350 );
        spotlight.angle = 0.5;                      // 光柱宽
        spotlight.penumbra = 0.5;                   
        spotlight.castShadow = true;
        spotlight.shadow.mapSize.width = 1024;
        spotlight.shadow.mapSize.height = 1024;
        // scene.add( new THREE.CameraHelper( light.shadow.camera ) );
        scene.add( spotlight );
        // 点光源
        pointlight = new THREE.PointLight( 0xff0040, 1, 500 );
        // pointlight.position.set(1,0,1);
        // 点光源添加光点
        var sphere = new THREE.SphereGeometry( 1, 16, 8 );
        pointlight.add(new THREE.Mesh(sphere, new THREE.MeshBasicMaterial({ color: 0xff0040 } )));
        scene.add( pointlight );
    }
    
    // 物体
    function initObj(){
        var geometry = new THREE.CubeGeometry(200,100,50);
        var material = new THREE.MeshLambertMaterial({color:0x00ff00});
        mesh = new THREE.Mesh(geometry,material);
        mesh.position = new THREE.Vector3(0,0,0);
        scene.add(mesh); 
    }
    // 模型加载
    function initLoad(){
        var onProgress = function ( xhr ) {  
            if ( xhr.lengthComputable ) {  
                var percentComplete = xhr.loaded / xhr.total * 100;  
                console.log( Math.round(percentComplete, 2) + '% downloaded' );  
            }
        };  
        var onError = function ( xhr ) {  
            console.log('error');
        };  
        var mtlLoader = new THREE.MTLLoader();               // 加载纹理
        mtlLoader.load('models/jugg/543ae7255e6a8.mtl', function(materials) { 
            // materials.preload(); 
            var objLoader = new THREE.OBJLoader();           // 加载模型
            // objLoader.setMaterials(materials);
            objLoader.load( 'models/jugg/543ae7257d2af.obj', function ( object ) { 
                // object.traverse( function ( child ) {  
                //     if ( child instanceof THREE.Mesh ) {  
                //         child.material.map = texture;  
                //     }  
                // } );  
                object.scale.x = 1;
                object.scale.y = 1;
                object.scale.z = 1; 
                object.updateMatrix();  
                object.position.y = 0;  
                model = object;
                object.castShadow = true;
                scene.add(object);
            }, onProgress, onError ); 
        })
    }

    // 循环
    function render() {
        requestAnimationFrame(render);
        controls.update();
        var time = Date.now() * 0.0005;
        pointlight.position.x = Math.sin( time * 0.7 ) * -50;
        pointlight.position.y = 100;
        pointlight.position.z = Math.cos( time * 0.3 ) * 50;
        renderer.render(scene, camera);
    }

    // 性能监视器
    function initStats(){
        var stats = new Stats();
        stats.setMode(0); // 0: fps, 1: ms
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.left = '5px';
        stats.domElement.style.top = '5px';
        document.body.appendChild( stats.domElement );
        setInterval( function () {
            stats.begin();
            // 你的每一帧的代码
            stats.end();
        }, 1000 / 60 );
    }

    var change_camera = false;
    var mousePos = [0,0];
    $('body').mousedown(function(e){
        change_camera = true;
        mousePos = [e.clientX,e.clientY];
    })
    $('body').mouseup(function(){
        change_camera = false;
    })
    // 鼠标移动事件
    function handleMouseMove(event) {
        if(change_camera){
            var tx = event.clientX;
            var ty = event.clientY;
            camera.position.x += (tx-mousePos[0])*0.01;
            camera.position.y += -(ty-mousePos[1])*0.01;
        }
       
    }
    // 滚轮事件
    function handleMouseWheel(event) {
        var wheel = event.wheelDelta*0.002;
        model.rotation.y += wheel;
    }


    function start(){
        init();
        // initObj();
        initLoad();
        initLight();
        initStats();
        render();
        //添加监听器
        // document.addEventListener('mousemove', handleMouseMove, false);
        // document.addEventListener('mousewheel',handleMouseWheel,false);
    }

    if (Detector.webgl) {
        start();
    } else {
        var warning = Detector.getWebGLErrorMessage();
        document.body.appendChild(warning);
    }
</script>
</html>